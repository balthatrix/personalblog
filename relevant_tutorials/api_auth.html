
<!DOCTYPE html><html><head><title>API authentication using Devise and Doorkeeper (minimal setup)</title><meta name="description" content="Have you ever tried to setup Devise and Doorkeeper in the simplest possible way, without oauth applications etc? Here it is! In this article, I&amp;#39;ll show you in a few easy steps that setup you searched for!
Read more"><meta property="og:title" content="API authentication using Devise and Doorkeeper (minimal setup)"><meta property="og:image" content="http://naturaily.com/assets/post_images/ancient-hall.jpg"><meta property="og:url" content="http://naturaily.com/blog/post/api-authentication-using-devise-and-doorkeeper-minimal-setup"><meta property="og:description" content="Have you ever tried to setup Devise and Doorkeeper in the simplest possible way, without oauth applications etc? Here it is! In this article, I&amp;#39;ll show you in a few easy steps that setup you searched for!
Read more"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="http://naturaily.com/blog/post/api-authentication-using-devise-and-doorkeeper-minimal-setup"><meta name="twitter:title" content="API authentication using Devise and Doorkeeper (minimal setup)"><meta name="twitter:description" content="Have you ever tried to setup Devise and Doorkeeper in the simplest possible way, without oauth applications etc? Here it is! In this article, I&amp;#39;ll show you in a few easy steps that setup you searched for!
Read more"><meta name="twitter:image" content="http://naturaily.com/assets/post_images/ancient-hall.jpg"><link rel="icon" type="image/png" href="/images/naturaily-favicon.png"><meta name="google-site-verification" content="hN08h2wKl7pGAbXTpkyglvv4VdgIBfm5TAGozNPUhJM"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/stylesheets/application.min.css"><script src="http://maps.google.com/maps/api/js?sensor=false"></script></head><body class="page--is-blog page--is-post"><!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-53P6SP"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-53P6SP');</script>
<!-- End Google Tag Manager -->
<div id="fb-root"><script>(function(d, s, id) {
var js, fjs = d.getElementsByTagName(s)[0];
if (d.getElementById(id)) return;
js = d.createElement(s); js.id = id;
js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&appId=686856578063685&version=v2.0";
fjs.parentNode.insertBefore(js, fjs);
}
(document, 'script', 'facebook-jssdk'));
</script></div><div><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');
</script></div><div><script>window.twttr = (function(d, s, id) {
var js, fjs = d.getElementsByTagName(s)[0],
t = window.twttr || {};
if (d.getElementById(id)) return t;
js = d.createElement(s);
js.id = id;
js.src = "https://platform.twitter.com/widgets.js";
fjs.parentNode.insertBefore(js, fjs);
t._e = [];
t.ready = function(f) {
t._e.push(f);
};
return t;
}(document, "script", "twitter-wjs"));
</script></div><div><script src="https://apis.google.com/js/platform.js" async="async" defer="defer">{lang: 'pl'}</script></div><header class="header header--static"><div class="header--wrap row"><div class="contain-to-grid"><nav class="top-bar nav--main-nav"><ul class="title-area"><li class="name"><h2><a href="/" title="Naturaily, Ruby on Rails Team Poland" class="replace--logo">Naturaily</a></h2></li><li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li></ul><section class="top-bar-section"><ul class="right social--list"><li><a href="http://www.facebook.com/Naturaily" class="social--list-link"><img src="/images/facebook.png"></a></li><li><a href="http://www.twitter.com/naturailycom" class="social--list-link"><img src="/images/twitter.png"></a></li><li><a href="https://plus.google.com/111823553806501023330" class="social--list-link"><img src="/images/google.png"></a></li></ul><ul class="right"><li><a href="/#work">About us</a></li><li><a href="/#portfolio">Portfolio</a></li><li><a href="/#clients">Clients</a></li><li><a href="/#about">Team</a></li><li><a href="/jobs" id="nav-jobs">Jobs</a></li><li><a href="/blog" id="nav-blog">Blog</a></li><li><a href="/#hire-us" title="Build your startup with a great Polish developers" class="button--bg-pink-small">Let's talk!</a></li></ul></section></nav></div></div></header><div class="l--pages"><section class="page--theme-top page--theme-push-top"><section class="row blog--header-wrap"><div class="column small--full"><div class="text-center blog--header-wrap-div"><h3 class="page-header">We blog about startups, Ruby on Rails and Meteor web development.<!--span.replace--naturaily-big Naturaily--></h3></div></div></section><div class="blog--single-post hide-for-small"><div class="blog--header-single-post"><img src="/assets/post_images/ancient-hall.jpg" class="blog--header-single-post-image"><div class="blog--header-author blog--header-author-single"><div class="row"><div class="column small-2 large-2"><img src="/assets/authors/janpol.png" alt="Jan Wieczorkowski - Ruby and JavaScript Developer" class="post--preview-avatar"></div><div class="column small-10 large-10"><h1>API authentication using Devise and Doorkeeper (minimal setup)</h1><span class="text-small">by&nbsp;</span><a href="/blog/author/Jan%20Wieczorkowski" class="blog--header-single-post-link text-large"> Jan Wieczorkowski</a></div></div></div></div></div></section><section class="page--theme-white gfx--yellow"><div class="row"><div class="column large-9"><div class="row"><div class="blog--post column small-full"><header class="post--header"><h1 class="post--title"><a href="/blog/post/api-authentication-using-devise-and-doorkeeper-minimal-setup">API authentication using Devise and Doorkeeper (minimal setup)</a></h1><div class="image-for-small-screens show-for-small"><div class="blog--single-post"><div class="blog--header-single-post"><a href="/blog/post/api-authentication-using-devise-and-doorkeeper-minimal-setup"><img src="/assets/post_images/ancient-hall.jpg" alt="API authentication using Devise and Doorkeeper (minimal setup)" class="blog--header-single-post-image"></a></div></div></div><section class="post--details"><div class="post--detail post--author"><i class="icon--author"></i><a href="/blog/author/Jan%20Wieczorkowski">Jan Wieczorkowski</a></div><div class="post--detail post--date"><i class="icon--date"></i>Monday, 22/08/2016</div><div class="post--detail post--category"><i class="icon--category"></i><a href="/blog/category/Ruby%20on%20Rails">Ruby on Rails</a></div><div class="post--detail post--tags"><i class="icon--tag"></i><a href="/blog/tag/ruby%20on%20rails" class="post--tag">ruby on rails</a><a href="/blog/tag/devise" class="post--tag">devise</a><a href="/blog/tag/doorkeeper" class="post--tag">doorkeeper</a><a href="/blog/tag/ruby" class="post--tag">ruby</a></div></section></header><section class="post--content"><p>Have you ever tried to setup Devise and Doorkeeper in the simplest possible way, without oauth applications etc? Here it is! In this article, I&#39;ll show you in a few easy steps that setup you searched for!</p>
<p>Let’s start by creating new, simple Rails application (or clone this one <a href="https://github.com/Naturaily/devise-doorkeeper">https://github.com/Naturaily/devise-doorkeeper</a>).</p>
<ol>
<li><code>rails new myapp</code></li>
<li><code>cd myapp</code></li>
<li><code>rails g scaffold items name:string description:text</code></li>
<li><code>rake db:migrate</code></li>
<li>add <code>root to: &#39;items#index&#39;</code> to <code>config/routes.rb</code></li>
</ol>
<p>Now we have a simple app with Items CRUD. Let’s add some code to handle Users.</p>
<ol>
<li>add <code>gem &#39;devise&#39;</code> to Gemfile and run <code>bundle install</code></li>
<li><code>rails g devise:install</code></li>
<li><code>rails g devise User</code></li>
<li><code>rake db:migrate</code></li>
<li><code>add before_action :authenticate_user!</code> to <code>items_controller</code></li>
</ol>
<p>OK, only logged in users can CRUD items now. Off to the most exciting part. We want the very same feature on the API, because mobile app is being created. We want the Items CRUD available and we will authenticate every action using Doorkeeper for this, because it’s the easiest thing you can do.</p>
<p>Let’s install Doorkeeper.</p>
<ol>
<li>add <code>gem &#39;doorkeeper&#39;</code> to Gemfile and run <code>bundle install</code></li>
<li><code>rails g doorkeeper:install</code></li>
<li><code>rails g doorkeeper:migration</code></li>
</ol>
<p>Now edit that new migration, it should look like this:</p>
<pre><code>class CreateDoorkeeperTables &lt; ActiveRecord::Migration
 def change
   create_table :oauth_access_tokens do |t|
     t.integer  :resource_owner_id
     t.integer  :application_id
     t.string   :token,                  null: false
     t.string   :refresh_token
     t.integer  :expires_in
     t.datetime :revoked_at
     t.datetime :created_at,             null: false
     t.string   :scopes
   end

   add_index :oauth_access_tokens, :token, unique: true
   add_index :oauth_access_tokens, :resource_owner_id
   add_index :oauth_access_tokens, :refresh_token, unique: true
   add_foreign_key(
     :oauth_access_tokens,
     :users,
     column: :resource_owner_id
   )
 end
end
</code></pre><p>We removed <code>oauth_applications</code> and <code>oauth_access_grants</code> tables (we simply don’t need them). We need to remove associated foreing keys and indexes too. I also removed previous_refresh_token field from <code>oauth_access_tokens</code> table (please read the comment generated by Doorkeeper). And there is a little hack too. We need to change
    <code>t.references :application, null: false</code>
to
    <code>t.integer :application_id</code>
Without that our example won’t work!</p>
<p>Now we can run migrations</p>
<p><code>rake db:migrate</code></p>
<p>We need to mount doorkeeper in our router. It can be easily done by <code>use_doorkeeper</code> method. But we should rembember that we need nothing but tokens! So our code in <code>config/routes.rb</code> can looks like the code below:</p>
<pre><code>use_doorkeeper do
  skip_controllers :authorizations, :applications,
    :authorized_applications
end
</code></pre><p>Now let’s integrate Doorkeeper with Devise. First, we need a method to find user by email and password. Let’s edit <code>app/models/user.rb</code>.</p>
<pre><code> class &lt;&lt; self
   def authenticate(email, password)
     user = User.find_for_authentication(email: email)
     user.try(:valid_password?, password) ? user : nil
   end
 end
</code></pre><p>Next we configure Doorkeeper in <code>config/initializers/doorkeeper.rb</code> to use this method.</p>
<pre><code> resource_owner_from_credentials do |_routes|
   User.authenticate(params[:email], params[:password])
 end
</code></pre><p>Don’t forget to let Doorkeeper access token with a password.</p>
<pre><code> grant_flows %w(password)
</code></pre><p>We also want refresh tokens, so we need to uncomment the line with <code>use_refresh_token</code>.</p>
<p>Next, we skip app authorization.</p>
<pre><code> skip_authorization do
   true
 end
</code></pre><p>There we go! We can now log in and log out to our API. Try this (please remember to keep the server launched):</p>
<pre><code>curl -X POST -d &#39;grant_type=password&amp;email=user@example.com&amp;password=yourpassword’ localhost:3000/oauth/token
</code></pre><pre><code>{&quot;access_token”:”YourAccessToken”,”token_type&quot;:&quot;bearer&quot;,&quot;expires_in&quot;:7200,&quot;refresh_token”:”YourRefreshToken”,”created_at&quot;:1470946931}%
</code></pre><p>DON’T FORGET TO USE SSL on production and staging environments!</p>
<p>OK, it’s time to use our tokens! Let’s retrieve some Items from our API. How? We need two new controllers. Why two? Because we should have separate controllers for API, so we need ItemsController and base controller for API.</p>
<p>We need <code>app/controllers/api/base_controller.rb</code>, a really simple one.</p>
<pre><code>class Api::BaseController &lt; ActionController::API
  respond_to :json
end
</code></pre><p>And <code>app/controller/api/items_controller.rb</code> (exemplary implementation).</p>
<pre><code>class Api::ItemsController &lt; Api::BaseController
  before_action :doorkeeper_authorize! # equivalent of authenticate_user!

  def index
    @items = Item.all
    respond_with @items
  end

  # the rest of actions
end
</code></pre><p>The most important part of code here is <code>before_action :doorkeeper_authorize!</code>. <code>doorkeeper_authorize!</code> is equaivalent of <code>authenticate_user!</code>. Without that every user could CRUD ours items.</p>
<p>The last one thing: add a new route</p>
<pre><code>namespace :api do
  resources :items
end
</code></pre><p>And that’s it! Let’s give it a try.</p>
<pre><code>curl -v localhost:3000/api/items
&lt; HTTP/1.1 401 Unauthorized
</code></pre><pre><code>curl -v localhost:3000/api/items?access_token=OurAccessTokenReturnedByAPI
&lt; HTTP/1.1 200 OK
[{&quot;id&quot;:1,&quot;name&quot;:&quot;Item&quot;,&quot;description&quot;:&quot;Amazing Item.&quot;,&quot;created_at&quot;:&quot;2016-08-11T19:25:09.649Z&quot;,&quot;updated_at&quot;:&quot;2016-08-11T19:25:09.649Z&quot;}]
</code></pre><p>It works! Yay!</p>
<p>Is that all? Definitely no! We still don’t have registration via API. But there’s no need to describe it here, someone else has done that already. Please check <a href="http://blog.andrewray.me/how-to-set-up-devise-ajax-authentication-with-rails-4-0/">this</a> post.</p>
<p>Goodbye and good luck!</p>
</section><footer class="post--footer"><section class="row"><div class="column small--full facebook-like-widget"><ul class="post--sharing"><li><div data-href="http://naturaily.com/blog/post/api-authentication-using-devise-and-doorkeeper-minimal-setup" data-width="450" data-layout="button_count" data-show-faces="false" data-send="false" class="fb-like post--sharing-fb"></div></li><li><a data-pocket-label="pocket" data-pocket-count="horizontal" data-lang="en" class="pocket-btn"></a><script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script></li><li><a href="https://twitter.com/share" class="twitter-share-button">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li><li class="sharing--linked-in"><script src="//platform.linkedin.com/in.js" type="text/javascript"></script><script type="IN/Share" data-counter="right"></script></li><li class="sharing--g-plus"><div data-action="share" data-annotation="bubble" class="g-plus"></div><script>;(function() {
var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
po.src = 'https://apis.google.com/js/platform.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
})();
</script></li></ul><hr class="separator--grey"></div></section><div class="row post--user-info"><section class="post--author-info column large-5 small--full post--author-info_with-avatar"><h5 class="column-header">Jan Wieczorkowski</h5><p class="post--author-info-bio">Janek is a Ruby&amp;JavaScript developer. He’s passionate about programming and solving software puzzles. When he’s not focused on development, he’s probably listening to music or playing bass. He even started to like jazz recently.</p><a href="/blog/author/Jan%20Wieczorkowski" class="button--bg-white button--inline button--small button--no-margin">See all posts by Jan</a><img src="/assets/authors/janpol.png" class="post--author-info-avatar"></section><section class="post--posts-by-author column large-7 small--full"><h5 class="column-header">Other posts by Jan</h5><ul class="list--diamonds"><li><a href="/blog/post/run-services-in-the-background">Run services in the background</a></li><li><a href="/blog/post/how-to-handle-translations-in-meteor-autoform-based-forms">How to handle translations in Meteor AutoForm-based forms</a></li></ul></section><span class="column small--full"><hr class="separator--grey"></span></div><section class="post--disqus row"><div class="column small--full"><div id="disqus_thread"></div></div></section><script>var disqus_shortname = 'naturaily';

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script></footer></div></div></div><div class="column small-3 hide-for-small hide-for-medium"><a href="/" title="Yeah, go on!" class="button--pink"><strong>Learn more about Naturaily and what we do</strong><div class="replace--naturaily-small-btn">Naturaily</div></a><div class="categories"><h3>Categories</h3><ul><li><a href="/blog/category/Android">Android<span class="right">2</span></a></li><li><a href="/blog/category/CSS">CSS<span class="right">1</span></a></li><li><a href="/blog/category/Development">Development<span class="right">1</span></a></li><li><a href="/blog/category/Infographic">Infographic<span class="right">1</span></a></li><li><a href="/blog/category/JavaScript">JavaScript<span class="right">5</span></a></li><li><a href="/blog/category/Management">Management<span class="right">1</span></a></li><li><a href="/blog/category/Online%20marketing">Online marketing<span class="right">1</span></a></li><li><a href="/blog/category/Project%20managment">Project managment<span class="right">1</span></a></li><li><a href="/blog/category/Remote%20development">Remote development<span class="right">1</span></a></li><li><a href="/blog/category/Responsive%20Web%20Design">Responsive Web Design<span class="right">1</span></a></li><li><a href="/blog/category/Ruby%20on%20Rails">Ruby on Rails<span class="right">8</span></a></li><li><a href="/blog/category/SASS">SASS<span class="right">1</span></a></li><li><a href="/blog/category/Social%20media">Social media<span class="right">1</span></a></li><li><a href="/blog/category/Spree%20Commerce">Spree Commerce<span class="right">1</span></a></li><li><a href="/blog/category/Startup">Startup<span class="right">3</span></a></li><li><a href="/blog/category/Thoughts%20on%20building%20start-ups">Thoughts on building start-ups<span class="right">3</span></a></li><li><a href="/blog/category/Women%20in%20IT">Women in IT<span class="right">1</span></a></li></ul></div><div class="aside--jobs-box"><p class="aside--jobs-title">Jobs at Naturaily</p><ul><li><a href="/jobs/frontend-engineer">Frontend Engineer</a></li><li><a href="/jobs/meteor-developer">Meteor Developer</a></li><li><a href="/jobs/project-manager">Project Manager</a></li><li><a href="/jobs/infrastructure-engineer">Infrastructure Engineer</a></li><li><a href="/jobs/ios-developer">iOS Developer</a></li><li><a href="/jobs/android-developer">Android Developer</a></li><li><a href="/jobs/ruby-on-rails-developer">Ruby on Rails Developer</a></li><li><a href="/jobs/content-marketing-specialist">Content Marketing Specialist</a></li></ul></div><a href="https://twitter.com/naturailycom" data-widget-id="504544011143507968" class="twitter-timeline">Tweets by @naturailycom</a></div></div></section><section class="page--theme-grey gfx--white"><section class="row blog--footer"><section class="column small--full large--half"><h4 class="underlined-header">See recent posts</h4><ul class="blog--link-list"><li class="item"><a href="/blog/post/6-books-every-beginner-developer-needs-to-read">6 books every beginner developer needs to read</a></li><li class="item"><a href="/blog/post/importing-data-to-database-in-rails-50-times-faster-than-normal">Importing data to database in Rails 50 times faster than normal</a></li><li class="item"><a href="/blog/post/7-aspects-of-our-lives-revolutionized-by-fin-tech">7 aspects of our lives revolutionized by fin-tech</a></li><li class="item"><a href="/blog/post/run-services-in-the-background">Run services in the background</a></li><li class="item"><a href="/blog/post/the-biggest-fears-of-software-developers">The biggest fears of software developers</a></li><li class="item"><a href="/blog/post/ruby-on-rails-implementation-of-a-ranking-system-using-postgresql-window-functions">Ruby on Rails implementation of a ranking system using PostgreSQL window functions</a></li><li class="item"><a href="/blog/post/ruby-on-rails-view-components-with-trailblazer-cells">Ruby on Rails view components with Trailblazer Cells</a></li><li class="item"><a href="/blog/post/first-steps-in-a-wide-vast-app-world-android-developer-guidance-on-showing-help-screens">First steps in a wide, vast app world. Android developer guidance on showing help screens</a></li><li class="item"><a href="/blog/post/what-a-non-technical-person-needs-to-know-when-working-with-a-development-team">What a non-technical person needs to know when working with a development team</a></li><li class="item"><a href="/blog/post/first-steps-in-a-wide-vast-app-world-android-developer-guidance-on-user-experience-and-process-thinking">First steps in a wide, vast app world. Android developer guidance on user experience and process thinking</a></li></ul></section><section class="column small--full large--half"><h4 class="underlined-header">Browse categories</h4><ul class="blog--link-list"><li class="item"><a href="/blog/category/Android">Android</a></li><li class="item"><a href="/blog/category/CSS">CSS</a></li><li class="item"><a href="/blog/category/Development">Development</a></li><li class="item"><a href="/blog/category/Infographic">Infographic</a></li><li class="item"><a href="/blog/category/JavaScript">JavaScript</a></li><li class="item"><a href="/blog/category/Management">Management</a></li><li class="item"><a href="/blog/category/Online%20marketing">Online marketing</a></li><li class="item"><a href="/blog/category/Project%20managment">Project managment</a></li><li class="item"><a href="/blog/category/Remote%20development">Remote development</a></li><li class="item"><a href="/blog/category/Responsive%20Web%20Design">Responsive Web Design</a></li><li class="item"><a href="/blog/category/Ruby%20on%20Rails">Ruby on Rails</a></li><li class="item"><a href="/blog/category/SASS">SASS</a></li><li class="item"><a href="/blog/category/Social%20media">Social media</a></li><li class="item"><a href="/blog/category/Spree%20Commerce">Spree Commerce</a></li><li class="item"><a href="/blog/category/Startup">Startup</a></li><li class="item"><a href="/blog/category/Thoughts%20on%20building%20start-ups">Thoughts on building start-ups</a></li><li class="item"><a href="/blog/category/Women%20in%20IT">Women in IT</a></li></ul></section></section></section></div><footer class="footer--page-footer"><ul class="footer--utility"><li><h1 class="footer-title hide-for-medium-down">Crafted by Naturaily, Ruby on Rails and Meteor development team</h1></li></ul><p class="footer--copy">&copy; 2013-2015 Naturaily. All rights reserved.<a href="/tos" class="default-link">Terms of Service</a><!--span.replace--naturaily-small.--><!--  Naturaily--></p><div class="right footer--socials"><span class="footer--socials-fb"><a data-href="https://www.facebook.com/Naturaily?ref=br_rs" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false" class="fb-like"></a></span><span class="footer--socials-twitter"><a href="https://twitter.com/naturailycom" data-show-count="false" data-dnt="true" class="twitter-follow-button">Follow @naturailycom</a></span><span class="footer--socials-gplus"><a href="https://plus.google.com/u/2/+Naturailycom/posts" data-size="medium" class="g-plusone"></a></span></div></footer><script src="/javascripts/application.min.js"></script></body></html>
